from refspy import refspy
from refspy.utils import sequential_replace

URL = "https://github.com/eukras/refspy/demo.py"

__ = refspy()

text = """
Human-written Bible references look like Rom 1:1, 6-7, 1 Cor 2-3, or Phlm 2-3.
They can use spaces in the number part and commas between references. A
reference to a book, say Second Corinthians, will provide context for
references that follow, say, 5:21 or vv.25,37-38. If we refer to say Romans
(but then add a reference to Gal 4:4 in parentheses), a subsequent reference
like 12:16 will still be to Romans.
"""

matches = __.find_references(text, include_books=True)
strs, tags = [], []
for match_str, ref in matches:
    strs.append(match_str)
    if ref.is_book():
        tags.append(f'<span class="yellow">{match_str}</span>')
    else:
        tags.append(
            f'<span class="green">{match_str}</span><sup>{__.abbrev(ref)}</sup>'
        )
index = []
for library, book_collation in __.collate(
    sorted([ref for _, ref in matches if not ref.is_book()])
):
    for book, reference_list in book_collation:
        new_reference = __.merge(reference_list)
        index.append(__.abbrev(new_reference))


print("""
<html>
    <head>
        <style>
            a { text-decoration: none; }
            sup { font-family: sans-serif; font-size: xx-small;
                  color: purple; padding: 1px 3px; border: 1px solid purple;
                  border-radius: 3px; margin-left: 2px; }
            .green { background-color: #aaffaa; }
            .yellow { background-color: #ffffaa; }
        </style>
    </head>
    <body>
        <p><b>REFSPY</b>. <i>A Python library for working with biblical
        references in ordinary text.</i></p>
        <p>In the demonstration text below, references are highlighted in
        green, while book names that aren't themselves references but are used
        for context are highlighted in yellow. The identified references are
        noted in superscript, and an index is compiled at the end.</p>

""")
print(f"""
        <pre>{text}</pre>
        <blockquote>{sequential_replace(text, strs, tags)}</blockquote>
        <p><b>Index</b>. {"; ".join(index)}</p>
        <p> Because a number or a range (1 or 2-3) could refer to either verses or
        chapters, or other regular numbers that have nothing to do with biblical
        referencing, we only match references that are preceded by a book name, a
        chapter number and colon (4:), or a verse marker (v., vv.).</p>
        <p>Generated by: <a href="{URL}">{URL}</a><p>
    </body>
</html>
""")
